<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partiu ‚Äî Checklist + Cart√£o de Viagem</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --shadow:0 10px 28px rgba(17,24,39,.08);
      --r:18px;

      --nl:#2563eb;
      --br:#16a34a;

      --doc:#7c3aed;
      --saude:#ef4444;
      --hig:#0ea5e9;
      --ele:#f97316;
      --roup:#a855f7;
      --bag:#0f766e;
      --fin:#22c55e;
      --out:#64748b;

      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#16a34a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 15% 0%, rgba(37,99,235,.09), transparent 50%),
                  radial-gradient(900px 500px at 95% 10%, rgba(249,115,22,.10), transparent 50%),
                  var(--bg);
      color:var(--text);
    }

    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(247,248,251,.75);
      border-bottom:1px solid rgba(229,231,235,.7);
    }

    .top{
      max-width:1050px;margin:0 auto;
      padding:12px 14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(249,115,22,.95));
      box-shadow: var(--shadow);
    }
    .title{line-height:1.05}
    .title b{display:block;font-size:15px}
    .title span{font-size:12px;color:var(--muted)}

    .person{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      font-size:12px;color:var(--muted);
    }
    input[type="text"], input[type="datetime-local"], input[type="time"]{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;outline:none;
    }

    .wrap{max-width:1050px;margin:0 auto;padding:16px 14px 60px}
    .bigName{
      font-weight:900;
      font-size: clamp(26px, 5.6vw, 42px);
      letter-spacing:-.02em;
      margin-top:8px;
    }
    .sub{color:var(--muted);margin-top:6px;font-size:14px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.9);
      cursor:pointer;user-select:none;
      display:flex;gap:8px;align-items:center;
      transition:.12s transform, .12s background, .12s border;
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(249,115,22,.08));
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:#374151;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
    }

    .badge{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);
      background:#fff;
      padding:4px 8px;border-radius:999px;
      white-space:nowrap;
    }

    .alert{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:16px;border:1px solid var(--line);
      background:#fff;
    }
    .alert .dot{width:10px;height:10px;border-radius:999px;margin-top:5px;background:var(--warn)}
    .alert.ok .dot{background:var(--ok)}
    .alert.bad .dot{background:var(--bad)}
    .alert b{display:block}
    .alert small{color:var(--muted);display:block;margin-top:2px;line-height:1.35}

    .progressRow{
      margin-top:10px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;
    }
    .bar{height:10px;border-radius:999px;background:#eef2ff;overflow:hidden;flex:1;border:1px solid rgba(229,231,235,.95)}
    .fill{height:100%;width:0%;background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(249,115,22,.95))}
    .pct{min-width:82px;text-align:right;color:var(--muted);font-size:12px}

    .btn{
      border:none;border-radius:14px;padding:10px 12px;cursor:pointer;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(249,115,22,.95));
      color:#fff;font-weight:800;box-shadow:0 10px 18px rgba(124,58,237,.18);
    }
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:700}
    .btn.danger{background: rgba(239,68,68,.92); box-shadow:0 10px 18px rgba(239,68,68,.18)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .cats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 740px){ .cats{grid-template-columns:1fr} }

    .catCard{
      border-radius:18px;
      border:1px solid var(--line);
      background:#fff;
      overflow:hidden;
    }
    .catHead{
      padding:12px 12px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color:#fff;
    }
    .catHead b{font-size:14px}
    .catHead .count{font-size:12px;opacity:.95}
    .catBody{padding:10px 12px 12px}

    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border:1px solid var(--line);
      border-radius:14px;background:#fff;
    }
    .item input{margin-top:3px;transform:scale(1.15)}
    .item .meta{flex:1}
    .item .meta b{display:block;font-size:14px}
    .item .meta small{color:var(--muted);display:block;margin-top:2px}
    .item .actions{display:flex;gap:6px}
    .addMini{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
    }
    .addMini input{width:100%}

    textarea{
      width:100%;
      min-height:120px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      resize:vertical;
      font-family: inherit;
    }
    .linkList a{color:#2563eb;text-decoration:none;font-weight:800}
    .linkList a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    /* confetti canvas */
    #fx{position:fixed;inset:0;pointer-events:none;z-index:999;display:none}
  </style>
</head>
<body>
<canvas id="fx"></canvas>

<header>
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>Partiu ‚Äî Checklist + Cart√£o de Viagem</b>
        <span>leve ‚Ä¢ localStorage ‚Ä¢ pr√°tico</span>
      </div>
    </div>
    <div class="person">
      <span class="pill">Nome:</span>
      <input id="name" type="text" placeholder="Ex.: Ernandes" />
    </div>
  </div>
</header>

<div class="wrap">
  <div class="bigName" id="bigName">Seu checklist</div>
  <div class="sub">Tudo salva neste aparelho. Duas abas: Holanda e Brasil.</div>

  <div class="tabs">
    <div class="tab active" data-tab="nl">üá≥üá± Partiu Holanda</div>
    <div class="tab" data-tab="br">üáßüá∑ Partiu Brasil</div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <h3>
        Painel r√°pido
        <span class="badge" id="lastSaved">‚Äî</span>
      </h3>

      <div class="alert" id="countdownBox">
        <div class="dot"></div>
        <div>
          <b id="countdownTitle">Defina a data/hora da viagem</b>
          <small id="countdownText">Voc√™ vai ver a contagem regressiva aqui (e alerta quando estiver perto).</small>
        </div>
      </div>

      <div class="progressRow" title="Progresso do checklist da aba">
        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="pct" id="pct">0%</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn small ghost" id="btnDefault">Recarregar itens padr√£o</button>
        <button class="btn small ghost" id="btnUncheck">Desmarcar tudo</button>
        <button class="btn small danger" id="btnResetTab">Resetar aba</button>
      </div>

      <div class="hr"></div>

      <h3>Checklist por categoria <span class="badge" id="itemsCount">0 itens</span></h3>
      <div class="cats" id="cats"></div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn ghost" id="btnExport">Exportar backup (JSON)</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer;">Importar backup</label>
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </div>
      <div class="muted" style="font-size:12px;margin-top:10px;line-height:1.35">
        Dica: se limpar dados do navegador, perde tudo. Use exportar backup.
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h3>Cart√£o da Viagem <span class="badge" id="tabLabel">Holanda</span></h3>

      <div class="row">
        <input id="tripDate" type="datetime-local" />
        <input id="tripTime" type="time" title="Hora extra (opcional)" style="display:none"/>
      </div>

      <div class="row" style="margin-top:8px">
        <input id="from" type="text" placeholder="Sa√≠da (aeroporto/cidade) ‚Äî ex: GRU" style="flex:1" />
        <input id="to" type="text" placeholder="Chegada (aeroporto/cidade) ‚Äî ex: AMS" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="flight" type="text" placeholder="Voo ‚Äî ex: KL792" style="flex:1" />
        <input id="gate" type="text" placeholder="Port√£o ‚Äî ex: B12" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="connectCity" type="text" placeholder="Conex√£o (se tiver) ‚Äî ex: Lisboa" style="flex:1" />
        <input id="connectGate" type="text" placeholder="Port√£o da conex√£o ‚Äî ex: C3" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="baggage" type="text" placeholder="Bagagem: despacho? peso? (ex: 1x23kg + 1 mochila)" style="flex:1" />
      </div>

      <textarea id="tripNotes" placeholder="Notas r√°pidas: hor√°rio de check-in, onde trocar de voo, o que fazer ao chegar, endere√ßo do hotel, contatos, etc."></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSaveTrip">Salvar cart√£o</button>
        <button class="btn ghost" id="btnClearTrip">Limpar</button>
      </div>

      <div class="hr"></div>

      <h3>Lugares/Links (clic√°veis)</h3>
      <div class="muted" style="font-size:12px;margin-top:-6px;margin-bottom:8px">
        Voc√™ pode editar e adicionar links nas Notas & Links abaixo tamb√©m.
      </div>
      <div class="linkList" id="places"></div>

      <div class="hr"></div>

      <h3>Notas & Links</h3>
      <textarea id="notes" placeholder="Cole links aqui (reservas, seguro, mapa, museus), ou escreva lembretes."></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="btnSaveNotes">Salvar notas</button>
        <button class="btn ghost" id="btnClearNotes">Limpar notas</button>
      </div>
    </aside>
  </div>
</div>

<script>
/* ======================
   Storage
====================== */
const K = {
  name: "partiu_name_v2",
  state: "partiu_state_v2",
  trip: "partiu_trip_v2",
  notes: "partiu_notes_v2",
  savedAt: "partiu_savedAt_v2"
};

let activeTab = "nl";

const CATS = [
  {key:"Documentos", color:"var(--doc)"},
  {key:"Sa√∫de", color:"var(--saude)"},
  {key:"Higiene", color:"var(--hig)"},
  {key:"Eletr√¥nicos", color:"var(--ele)"},
  {key:"Roupas", color:"var(--roup)"},
  {key:"Bagagem", color:"var(--bag)"},
  {key:"Financeiro", color:"var(--fin)"},
  {key:"Outros", color:"var(--out)"}
];

const DEFAULT = {
  nl: [
    // Documentos
    ["Passaporte v√°lido (ideal: +3 meses ap√≥s sa√≠da)", "Documentos"],
    ["Passagens/itiner√°rio (PDF ou print)", "Documentos"],
    ["Reserva de hospedagem (ou carta-convite)", "Documentos"],
    ["Seguro-viagem (Schengen: cobertura alta)", "Documentos"],
    ["Comprovantes financeiros (cart√£o/limite/extrato)", "Documentos"],
    ["C√≥pia do passaporte (foto no celular + aqui nas notas)", "Documentos"],

    // Sa√∫de
    ["Rem√©dio pra dor de cabe√ßa (ex.: paracetamol/ibuprofeno)", "Sa√∫de"],
    ["Rem√©dio para alergia (se voc√™ usa)", "Sa√∫de"],
    ["Band-aid/curativo + pomadinha simples", "Sa√∫de"],
    ["Rem√©dios de uso cont√≠nuo + receita", "Sa√∫de"],

    // Higiene
    ["Escova de dente", "Higiene"],
    ["Pasta de dente", "Higiene"],
    ["Fio dental", "Higiene"],
    ["Len√ßo umedecido", "Higiene"],
    ["√Ålcool em gel (pequeno)", "Higiene"],
    ["Sabonete em sach√™ / mini", "Higiene"],
    ["Desodorante", "Higiene"],

    // Eletr√¥nicos
    ["Carregador do celular", "Eletr√¥nicos"],
    ["Cabo extra (reserva)", "Eletr√¥nicos"],
    ["Power bank carregado", "Eletr√¥nicos"],
    ["Adaptador de tomada (padr√£o europeu)", "Eletr√¥nicos"],
    ["Fone de ouvido", "Eletr√¥nicos"],

    // Roupas
    ["Casaco corta-vento/chuva (Holanda venta e chove)", "Roupas"],
    ["T√™nis confort√°vel (muita caminhada)", "Roupas"],
    ["Meias extras", "Roupas"],

    // Bagagem
    ["Etiqueta de mala (nome/contato)", "Bagagem"],
    ["Cadeado", "Bagagem"],
    ["Mochila de m√£o organizada", "Bagagem"],

    // Financeiro
    ["Cart√£o internacional habilitado + aviso ao banco", "Financeiro"],
    ["Euro em esp√©cie (pouco) ‚Äî s√≥ por seguran√ßa", "Financeiro"],

    // Outros
    ["Garrafa de √°gua vazia (encher ap√≥s seguran√ßa)", "Outros"],
    ["Lanchinho pr√°tico para o aeroporto", "Outros"],
    ["Checar clima 24h antes", "Outros"]
  ],
  br: [
    ["Documento com foto (RG bom ou CNH)", "Documentos"],
    ["Passagens/itiner√°rio (print)", "Documentos"],
    ["Reserva/endere√ßos importantes", "Documentos"],

    ["Rem√©dio pra dor de cabe√ßa", "Sa√∫de"],
    ["Rem√©dios de uso cont√≠nuo + receita", "Sa√∫de"],
    ["Protetor solar", "Sa√∫de"],
    ["Repelente", "Sa√∫de"],

    ["Escova de dente", "Higiene"],
    ["Pasta de dente", "Higiene"],
    ["Len√ßo umedecido", "Higiene"],
    ["√Ålcool em gel", "Higiene"],

    ["Carregador do celular", "Eletr√¥nicos"],
    ["Power bank", "Eletr√¥nicos"],

    ["Roupas adequadas ao clima", "Roupas"],
    ["Cal√ßado confort√°vel", "Roupas"],

    ["Etiqueta/cadeado de mala", "Bagagem"],
    ["Mochila de m√£o organizada", "Bagagem"],

    ["Cart√µes + dinheiro em esp√©cie", "Financeiro"],

    ["Fechar g√°s/√°gua, lixo fora, avisar algu√©m", "Outros"]
  ]
};

const PLACES = {
  nl: [
    {t:"Anne Frank House (reservar)", u:"https://www.annefrank.org/"},
    {t:"Rijksmuseum", u:"https://www.rijksmuseum.nl/"},
    {t:"Van Gogh Museum", u:"https://www.vangoghmuseum.nl/"},
    {t:"I amsterdam (dicas/agenda)", u:"https://www.iamsterdam.com/"},
    {t:"NS (trens)", u:"https://www.ns.nl/en"},
  ],
  br: [
    {t:"Google Maps", u:"https://maps.google.com/"},
    {t:"Previs√£o do tempo (geral)", u:"https://www.windy.com/"},
  ]
};

function nowISO(){ return new Date().toISOString(); }
function saveTS(){ localStorage.setItem(K.savedAt, nowISO()); renderSavedAt(); }

function loadState(){
  const raw = localStorage.getItem(K.state);
  if(!raw) return { nl:null, br:null };
  try{ return JSON.parse(raw); }catch{ return { nl:null, br:null }; }
}
function saveState(st){ localStorage.setItem(K.state, JSON.stringify(st)); saveTS(); }

function ensureList(st, tab){
  if(!st[tab]){
    st[tab] = DEFAULT[tab].map(([text,cat])=>({id:crypto.randomUUID(), text, cat, done:false}));
    saveState(st);
  }
  return st[tab];
}

function loadTrip(){
  const raw = localStorage.getItem(K.trip);
  if(!raw) return { nl:{}, br:{} };
  try{
    const o = JSON.parse(raw);
    return { nl:o.nl||{}, br:o.br||{} };
  }catch{ return { nl:{}, br:{} }; }
}
function saveTrip(o){ localStorage.setItem(K.trip, JSON.stringify(o)); saveTS(); }

function loadNotes(){
  const raw = localStorage.getItem(K.notes);
  if(!raw) return { nl:"", br:"" };
  try{
    const o = JSON.parse(raw);
    return { nl:o.nl||"", br:o.br||"" };
  }catch{ return { nl:"", br:"" }; }
}
function saveNotes(o){ localStorage.setItem(K.notes, JSON.stringify(o)); saveTS(); }

function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

/* ======================
   UI: name + tabs
====================== */
const nameEl = document.getElementById("name");
const bigNameEl = document.getElementById("bigName");
nameEl.value = localStorage.getItem(K.name) || "";
function applyName(){
  const n = nameEl.value.trim();
  localStorage.setItem(K.name, n);
  bigNameEl.textContent = n ? `${n} ‚Äî seu checklist` : "Seu checklist";
}
nameEl.addEventListener("input", applyName);
applyName();

document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    activeTab = t.dataset.tab;
    document.getElementById("tabLabel").textContent = activeTab==="nl" ? "Holanda" : "Brasil";
    renderAll();
  });
});

/* ======================
   Render checklist in category cards
====================== */
const catsEl = document.getElementById("cats");
const fillEl = document.getElementById("fill");
const pctEl = document.getElementById("pct");
const itemsCountEl = document.getElementById("itemsCount");

function renderChecklist(){
  const st = loadState();
  const list = ensureList(st, activeTab);

  // counts + progress
  const total = list.length || 1;
  const done = list.filter(x=>x.done).length;
  const pct = Math.round((done/total)*100);
  fillEl.style.width = pct + "%";
  pctEl.textContent = `${pct}% (${done}/${list.length})`;
  itemsCountEl.textContent = `${list.length} itens`;

  // Confetti when 100%
  if(list.length>0 && done===list.length) confetti();

  // group by category
  const map = {};
  CATS.forEach(c=>map[c.key]=[]);
  list.forEach(it=>{
    if(!map[it.cat]) map[it.cat]=[];
    map[it.cat].push(it);
  });

  catsEl.innerHTML = "";
  CATS.forEach(cat=>{
    const arr = map[cat.key] || [];
    const d = arr.filter(x=>x.done).length;
    const card = document.createElement("div");
    card.className = "catCard";

    const head = document.createElement("div");
    head.className = "catHead";
    head.style.background = `linear-gradient(135deg, ${cat.color}, rgba(17,24,39,.85))`;
    head.innerHTML = `<b>${esc(cat.key)}</b><div class="count">${d}/${arr.length}</div>`;

    const body = document.createElement("div");
    body.className = "catBody";

    const listBox = document.createElement("div");
    listBox.className = "list";

    arr.forEach(item=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <input type="checkbox" ${item.done?"checked":""}/>
        <div class="meta">
          <b>${esc(item.text)}</b>
        </div>
        <div class="actions">
          <button class="btn small ghost" title="Editar">‚úèÔ∏è</button>
          <button class="btn small danger" title="Excluir">üóëÔ∏è</button>
        </div>
      `;

      const cb = row.querySelector('input[type="checkbox"]');
      const btnE = row.querySelectorAll("button")[0];
      const btnD = row.querySelectorAll("button")[1];

      cb.addEventListener("change", ()=>{
        const s = loadState();
        const a = ensureList(s, activeTab);
        const idx = a.findIndex(x=>x.id===item.id);
        if(idx>=0){ a[idx].done = cb.checked; saveState(s); }
        renderAll();
      });

      btnE.addEventListener("click", ()=>{
        const nt = prompt("Editar item:", item.text);
        if(nt===null) return;
        const s = loadState();
        const a = ensureList(s, activeTab);
        const idx = a.findIndex(x=>x.id===item.id);
        if(idx>=0){ a[idx].text = (nt.trim()||a[idx].text); saveState(s); }
        renderAll();
      });

      btnD.addEventListener("click", ()=>{
        if(!confirm("Excluir este item?")) return;
        const s = loadState();
        s[activeTab] = ensureList(s, activeTab).filter(x=>x.id!==item.id);
        saveState(s);
        renderAll();
      });

      listBox.appendChild(row);
    });

    // add mini
    const add = document.createElement("div");
    add.className = "addMini";
    add.innerHTML = `
      <input type="text" placeholder="Adicionar em ${esc(cat.key)} (ex.: len√ßo umedecido)" />
      <button class="btn small">Adicionar</button>
    `;
    const inp = add.querySelector("input");
    const btn = add.querySelector("button");
    btn.addEventListener("click", ()=>{
      const txt = inp.value.trim();
      if(!txt) return;
      const s = loadState();
      const a = ensureList(s, activeTab);
      a.push({id:crypto.randomUUID(), text:txt, cat:cat.key, done:false});
      saveState(s);
      inp.value="";
      renderAll();
    });

    body.appendChild(listBox);
    body.appendChild(add);

    card.appendChild(head);
    card.appendChild(body);
    catsEl.appendChild(card);
  });
}

/* ======================
   Trip card + countdown
====================== */
const tripDateEl = document.getElementById("tripDate");
const fromEl = document.getElementById("from");
const toEl = document.getElementById("to");
const flightEl = document.getElementById("flight");
const gateEl = document.getElementById("gate");
const connectCityEl = document.getElementById("connectCity");
const connectGateEl = document.getElementById("connectGate");
const baggageEl = document.getElementById("baggage");
const tripNotesEl = document.getElementById("tripNotes");

const countdownBox = document.getElementById("countdownBox");
const countdownTitle = document.getElementById("countdownTitle");
const countdownText = document.getElementById("countdownText");

function renderTrip(){
  const trips = loadTrip();
  const t = trips[activeTab] || {};

  tripDateEl.value = t.tripDate || "";
  fromEl.value = t.from || "";
  toEl.value = t.to || "";
  flightEl.value = t.flight || "";
  gateEl.value = t.gate || "";
  connectCityEl.value = t.connectCity || "";
  connectGateEl.value = t.connectGate || "";
  baggageEl.value = t.baggage || "";
  tripNotesEl.value = t.tripNotes || "";

  renderCountdown();
}

function saveTripFromForm(){
  const trips = loadTrip();
  trips[activeTab] = {
    tripDate: tripDateEl.value || "",
    from: fromEl.value.trim(),
    to: toEl.value.trim(),
    flight: flightEl.value.trim(),
    gate: gateEl.value.trim(),
    connectCity: connectCityEl.value.trim(),
    connectGate: connectGateEl.value.trim(),
    baggage: baggageEl.value.trim(),
    tripNotes: tripNotesEl.value.trim()
  };
  saveTrip(trips);
  renderCountdown();
}

document.getElementById("btnSaveTrip").addEventListener("click", ()=>{
  saveTripFromForm();
  alert("Cart√£o da viagem salvo ‚úÖ");
});
document.getElementById("btnClearTrip").addEventListener("click", ()=>{
  if(!confirm("Limpar cart√£o da viagem desta aba?")) return;
  const trips = loadTrip();
  trips[activeTab] = {};
  saveTrip(trips);
  renderTrip();
});

function renderCountdown(){
  const trips = loadTrip();
  const t = trips[activeTab] || {};
  const val = t.tripDate || "";

  countdownBox.classList.remove("ok","bad");

  if(!val){
    countdownTitle.textContent = "Defina a data/hora da viagem";
    countdownText.textContent = "Preencha o Cart√£o da Viagem para ver a contagem regressiva e alerta.";
    countdownBox.querySelector(".dot").style.background = "var(--warn)";
    return;
  }

  const target = new Date(val);
  const now = new Date();
  const diffMs = target - now;

  if(isNaN(target.getTime())){
    countdownTitle.textContent = "Data inv√°lida";
    countdownText.textContent = "Ajuste a data/hora no cart√£o.";
    countdownBox.classList.add("bad");
    return;
  }

  const abs = Math.abs(diffMs);
  const mins = Math.floor(abs/60000);
  const days = Math.floor(mins/(60*24));
  const hrs = Math.floor((mins - days*24*60)/60);
  const m = mins - days*24*60 - hrs*60;

  // status logic
  if(diffMs < 0){
    countdownTitle.textContent = "Boa viagem! (data j√° passou)";
    countdownText.textContent = "Se quiser, atualize para o pr√≥ximo trecho ou pr√≥xima viagem.";
    countdownBox.classList.add("ok");
    countdownBox.querySelector(".dot").style.background = "var(--ok)";
    return;
  }

  // same day / tomorrow / soon
  const totalHours = diffMs / 3600000;
  if(totalHours <= 12){
    countdownTitle.textContent = "ALERTA: sua viagem est√° muito perto!";
    countdownText.textContent = `Faltam ${hrs}h ${m}min. Confere documentos, carregadores e chegue cedo.`;
    countdownBox.classList.add("bad");
    countdownBox.querySelector(".dot").style.background = "var(--bad)";
  }else if(totalHours <= 36){
    countdownTitle.textContent = "Amanh√£ / nas pr√≥ximas 24‚Äì36h";
    countdownText.textContent = `Faltam ${days}d ${hrs}h. Hoje √© dia de revisar tudo e separar a mochila.`;
    countdownBox.querySelector(".dot").style.background = "var(--warn)";
  }else{
    countdownTitle.textContent = "Contagem regressiva";
    countdownText.textContent = `Faltam ${days}d ${hrs}h ${m}min para a sa√≠da.`;
    countdownBox.classList.add("ok");
    countdownBox.querySelector(".dot").style.background = "var(--ok)";
  }
}

/* ======================
   Notes + places
====================== */
const notesEl = document.getElementById("notes");
function renderNotes(){
  const n = loadNotes();
  notesEl.value = n[activeTab] || "";
}
document.getElementById("btnSaveNotes").addEventListener("click", ()=>{
  const n = loadNotes();
  n[activeTab] = notesEl.value;
  saveNotes(n);
  alert("Notas salvas ‚úÖ");
});
document.getElementById("btnClearNotes").addEventListener("click", ()=>{
  if(!confirm("Limpar notas desta aba?")) return;
  const n = loadNotes();
  n[activeTab] = "";
  saveNotes(n);
  renderNotes();
});

function renderPlaces(){
  const p = PLACES[activeTab] || [];
  const el = document.getElementById("places");
  el.innerHTML = p.map(x=>`‚Ä¢ <a target="_blank" rel="noopener" href="${esc(x.u)}">${esc(x.t)}</a>`).join("<br/>");
}

/* ======================
   Buttons: defaults + reset
====================== */
document.getElementById("btnDefault").addEventListener("click", ()=>{
  if(!confirm("Recarregar itens padr√£o desta aba? Isso substitui sua lista atual.")) return;
  const st = loadState();
  st[activeTab] = DEFAULT[activeTab].map(([text,cat])=>({id:crypto.randomUUID(), text, cat, done:false}));
  saveState(st);
  renderAll();
});
document.getElementById("btnUncheck").addEventListener("click", ()=>{
  const st = loadState();
  const list = ensureList(st, activeTab).map(x=>({...x, done:false}));
  st[activeTab] = list;
  saveState(st);
  renderAll();
});
document.getElementById("btnResetTab").addEventListener("click", ()=>{
  if(!confirm("Resetar TUDO desta aba (checklist + cart√£o + notas)?")) return;
  const st = loadState(); st[activeTab]=null; saveState(st);

  const trips = loadTrip(); trips[activeTab] = {}; saveTrip(trips);
  const notes = loadNotes(); notes[activeTab] = ""; saveNotes(notes);

  renderAll();
});

/* ======================
   Export / import backup
====================== */
document.getElementById("btnExport").addEventListener("click", ()=>{
  const data = {
    version: 2,
    exportedAt: new Date().toISOString(),
    name: localStorage.getItem(K.name) || "",
    state: loadState(),
    trip: loadTrip(),
    notes: loadNotes()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `partiu-backup-${activeTab}-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!confirm("Importar vai sobrescrever seus dados atuais. Continuar?")) return;

    if(typeof data.name==="string"){ localStorage.setItem(K.name, data.name); nameEl.value=data.name; applyName(); }
    if(data.state) localStorage.setItem(K.state, JSON.stringify(data.state));
    if(data.trip) localStorage.setItem(K.trip, JSON.stringify(data.trip));
    if(data.notes) localStorage.setItem(K.notes, JSON.stringify(data.notes));
    saveTS();
    alert("Backup importado ‚úÖ");
    renderAll();
  }catch(err){
    alert("Falha ao importar. Verifique se √© um backup do app (JSON).");
  }finally{
    e.target.value="";
  }
});

/* ======================
   Last saved
====================== */
function renderSavedAt(){
  const el = document.getElementById("lastSaved");
  const raw = localStorage.getItem(K.savedAt);
  if(!raw){ el.textContent = "n√£o salvo ainda"; return; }
  const d = new Date(raw);
  el.textContent = "salvo: " + d.toLocaleString();
}

/* ======================
   Confetti (lightweight)
====================== */
const fx = document.getElementById("fx");
const ctx = fx.getContext("2d");
let confettiOn = false;

function confetti(){
  if(confettiOn) return;
  confettiOn = true;
  fx.style.display = "block";
  resizeFx();

  const pieces = Array.from({length: 120}).map(()=>({
    x: Math.random()*fx.width,
    y: -20 - Math.random()*fx.height*0.3,
    r: 4 + Math.random()*6,
    vy: 2 + Math.random()*4,
    vx: -1 + Math.random()*2,
    a: Math.random()*Math.PI
  }));

  let t = 0;
  const timer = setInterval(()=>{
    t++;
    ctx.clearRect(0,0,fx.width,fx.height);
    pieces.forEach(p=>{
      p.y += p.vy;
      p.x += p.vx;
      p.a += 0.08;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.a);
      ctx.fillStyle = `hsla(${Math.random()*360}, 90%, 55%, .9)`;
      ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*1.6);
      ctx.restore();
    });

    if(t>70){
      clearInterval(timer);
      ctx.clearRect(0,0,fx.width,fx.height);
      fx.style.display = "none";
      confettiOn = false;
    }
  }, 16);
}
function resizeFx(){
  fx.width = window.innerWidth;
  fx.height = window.innerHeight;
}
window.addEventListener("resize", resizeFx);

/* ======================
   Render all
====================== */
function renderAll(){
  renderSavedAt();
  renderPlaces();
  renderTrip();
  renderNotes();
  renderChecklist();
}
renderAll();

// keep countdown live
setInterval(()=>renderCountdown(), 30000);
</script>
</body>
</html>
