<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partiu ‚Äî Checklist + Cart√£o de Viagem</title>
  <style>
    :root{
      --bg:#f7f8fb; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --shadow:0 10px 28px rgba(17,24,39,.08); --r:18px;
      --warn:#f59e0b; --bad:#ef4444; --ok:#16a34a;

      --doc:#7c3aed; --saude:#ef4444; --hig:#0ea5e9; --ele:#f97316;
      --roup:#a855f7; --bag:#0f766e; --fin:#22c55e; --out:#64748b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(900px 500px at 15% 0%, rgba(37,99,235,.09), transparent 50%),
                  radial-gradient(900px 500px at 95% 10%, rgba(249,115,22,.10), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(247,248,251,.75);
      border-bottom:1px solid rgba(229,231,235,.7);
    }
    .top{
      max-width:1100px;margin:0 auto;padding:12px 14px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(249,115,22,.95));
      box-shadow: var(--shadow);
    }
    .title{line-height:1.05}
    .title b{display:block;font-size:15px}
    .title span{font-size:12px;color:var(--muted)}
    .person{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.9);font-size:12px;color:var(--muted);}
    input[type="text"], input[type="datetime-local"], select{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;outline:none;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 60px}
    .bigName{font-weight:900;font-size: clamp(26px, 5.6vw, 42px);letter-spacing:-.02em;margin-top:8px;}
    .sub{color:var(--muted);margin-top:6px;font-size:14px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background: rgba(255,255,255,.9);cursor:pointer;user-select:none;
      display:flex;gap:8px;align-items:center;
      transition:.12s transform, .12s background, .12s border;
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(135deg, rgba(37,99,235,.10), rgba(249,115,22,.08));
    }
    .tab .x{margin-left:6px;color:rgba(17,24,39,.55);font-weight:900}
    .tab .x:hover{color:rgba(239,68,68,.9)}

    .btn{
      border:none;border-radius:14px;padding:10px 12px;cursor:pointer;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(249,115,22,.95));
      color:#fff;font-weight:800;box-shadow:0 10px 18px rgba(124,58,237,.18);
    }
    .btn.ghost{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:700}
    .btn.danger{background: rgba(239,68,68,.92); box-shadow:0 10px 18px rgba(239,68,68,.18)}
    .btn.small{padding:8px 10px;border-radius:12px;font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .grid{margin-top:14px;display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;}
    @media (max-width: 950px){ .grid{grid-template-columns:1fr} }

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);border-radius: var(--r);
      box-shadow: var(--shadow);padding:14px;
    }
    .card h3{
      margin:0 0 10px;font-size:13px;letter-spacing:.02em;text-transform:uppercase;color:#374151;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .badge{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);background:#fff;padding:4px 8px;border-radius:999px;white-space:nowrap;
    }
    .alert{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:16px;border:1px solid var(--line);background:#fff;
    }
    .alert .dot{width:10px;height:10px;border-radius:999px;margin-top:5px;background:var(--warn)}
    .alert.ok .dot{background:var(--ok)}
    .alert.bad .dot{background:var(--bad)}
    .alert b{display:block}
    .alert small{color:var(--muted);display:block;margin-top:2px;line-height:1.35}

    .progressRow{
      margin-top:10px;display:flex;gap:10px;align-items:center;justify-content:space-between;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#fff;
    }
    .bar{height:10px;border-radius:999px;background:#eef2ff;overflow:hidden;flex:1;border:1px solid rgba(229,231,235,.95)}
    .fill{height:100%;width:0%;background: linear-gradient(90deg, rgba(124,58,237,.95), rgba(249,115,22,.95))}
    .pct{min-width:92px;text-align:right;color:var(--muted);font-size:12px}

    .cats{display:grid;grid-template-columns: 1fr 1fr;gap:12px;margin-top:12px;}
    @media (max-width: 740px){ .cats{grid-template-columns:1fr} }
    .catCard{border-radius:18px;border:1px solid var(--line);background:#fff;overflow:hidden;}
    .catHead{padding:12px 12px 10px;display:flex;align-items:center;justify-content:space-between;gap:10px;color:#fff;}
    .catHead b{font-size:14px}
    .catHead .count{font-size:12px;opacity:.95}
    .catBody{padding:10px 12px 12px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff;}
    .item input{margin-top:3px;transform:scale(1.15)}
    .item .meta{flex:1}
    .item .meta b{display:block;font-size:14px}
    .item .actions{display:flex;gap:6px}
    .addMini{margin-top:10px;display:grid;grid-template-columns: 1fr auto;gap:8px;}
    .addMini input{width:100%}

    textarea{
      width:100%;min-height:110px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;outline:none;resize:vertical;font-family: inherit;
    }
    .linkList a{color:#2563eb;text-decoration:none;font-weight:800}
    .linkList a:hover{text-decoration:underline}
    .muted{color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .uploader{border:1px dashed rgba(124,58,237,.35);background: rgba(124,58,237,.06);padding:12px;border-radius:16px;}
    .files{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .fileRow{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--line);border-radius:14px;background:#fff;}
    .fileLeft{display:flex;gap:10px;align-items:center;min-width:0}
    .thumb{width:44px;height:44px;border-radius:12px;border:1px solid var(--line);background:#f9fafb;display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto;}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .fname{min-width:0}
    .fname b{display:block;max-width: 320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px;}
    .fname small{color:var(--muted)}
    a.link{color:#2563eb;text-decoration:none;font-weight:900}
    a.link:hover{text-decoration:underline}

    #fx{position:fixed;inset:0;pointer-events:none;z-index:999;display:none}

    .modalBack{
      position:fixed;inset:0;background:rgba(17,24,39,.45);display:none;align-items:center;justify-content:center;z-index:9999;
      padding:18px;
    }
    .modal{
      width:min(520px, 96vw);
      background:#fff;border:1px solid var(--line);border-radius:18px;box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h4{margin:0 0 10px}
    .modal .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .modal .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<canvas id="fx"></canvas>

<div class="modalBack" id="modalBack">
  <div class="modal">
    <h4>Adicionar novo pa√≠s</h4>
    <div class="grid2">
      <div>
        <div class="muted" style="font-size:12px;margin-bottom:6px">Nome do pa√≠s</div>
        <input id="newCountryName" type="text" placeholder="Ex.: Jap√£o, Canad√°, Bol√≠via" />
      </div>
      <div>
        <div class="muted" style="font-size:12px;margin-bottom:6px">Clima base</div>
        <select id="newCountryClimate">
          <option value="temperado">Temperado</option>
          <option value="tropical">Tropical</option>
          <option value="frio">Frio</option>
          <option value="deserto">Seco/Deserto</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:12px;justify-content:flex-end">
      <button class="btn ghost" id="btnCancelCountry">Cancelar</button>
      <button class="btn" id="btnCreateCountry">Criar</button>
    </div>
    <div class="muted" style="font-size:12px;margin-top:8px;line-height:1.35">
      O pa√≠s novo ganha checklist, cart√£o, notas e arquivos pr√≥prios.
    </div>
  </div>
</div>

<header>
  <div class="top">
    <div class="brand">
      <div class="logo"></div>
      <div class="title">
        <b>Partiu ‚Äî Checklist + Cart√£o de Viagem</b>
        <span>com pa√≠ses ilimitados ‚Ä¢ localStorage</span>
      </div>
    </div>
    <div class="person">
      <span class="pill">Nome:</span>
      <input id="name" type="text" placeholder="Ex.: Ernandes" />
    </div>
  </div>
</header>

<div class="wrap">
  <div class="bigName" id="bigName">Seu checklist</div>
  <div class="sub" id="subline">Tudo salva neste aparelho. Crie pa√≠ses e adapte por clima.</div>

  <div class="tabs" id="tabs">
    <!-- tabs injected -->
    <button class="btn ghost" id="btnAddCountry">+ Novo pa√≠s</button>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <h3>
        Painel r√°pido
        <span class="badge" id="lastSaved">‚Äî</span>
      </h3>

      <div class="alert" id="countdownBox">
        <div class="dot"></div>
        <div>
          <b id="countdownTitle">Defina a data/hora da viagem</b>
          <small id="countdownText">Voc√™ vai ver a contagem regressiva aqui (e alerta quando estiver perto).</small>
        </div>
      </div>

      <div class="progressRow">
        <div class="bar"><div class="fill" id="fill"></div></div>
        <div class="pct" id="pct">0%</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn small ghost" id="btnDefault">Recarregar itens padr√£o</button>
        <button class="btn small ghost" id="btnUncheck">Desmarcar tudo</button>
        <button class="btn small danger" id="btnResetTab">Resetar pa√≠s</button>
      </div>

      <div class="hr"></div>

      <h3>Checklist por categoria <span class="badge" id="itemsCount">0 itens</span></h3>
      <div class="cats" id="cats"></div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn ghost" id="btnExport">Exportar backup (JSON)</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer;">Importar backup</label>
        <input id="importFile" type="file" accept="application/json" style="display:none;">
      </div>
      <div class="muted" style="font-size:12px;margin-top:10px;line-height:1.35">
        Dica: se limpar dados do navegador, perde tudo. Use exportar backup.
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h3>Cart√£o da Viagem <span class="badge" id="tabLabel">‚Äî</span></h3>

      <div class="row">
        <input id="tripDate" type="datetime-local" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="from" type="text" placeholder="Sa√≠da (aeroporto/cidade) ‚Äî ex: GRU" style="flex:1" />
        <input id="to" type="text" placeholder="Chegada (aeroporto/cidade) ‚Äî ex: AMS" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="flight" type="text" placeholder="Voo ‚Äî ex: KL792" style="flex:1" />
        <input id="gate" type="text" placeholder="Port√£o ‚Äî ex: B12" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="connectCity" type="text" placeholder="Conex√£o (se tiver) ‚Äî ex: Lisboa" style="flex:1" />
        <input id="connectGate" type="text" placeholder="Port√£o da conex√£o ‚Äî ex: C3" style="flex:1" />
      </div>

      <div class="row" style="margin-top:8px">
        <input id="baggage" type="text" placeholder="Bagagem: despacho? peso? (ex: 1x23kg + 1 mochila)" style="flex:1" />
      </div>

      <textarea id="tripNotes" placeholder="Notas r√°pidas: check-in, onde trocar de voo, o que fazer ao chegar, endere√ßo do hotel, contatos, etc."></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnSaveTrip">Salvar cart√£o</button>
        <button class="btn ghost" id="btnClearTrip">Limpar</button>
      </div>

      <div class="hr"></div>

      <h3>Arquivos & Fotos (localStorage)</h3>
      <div class="uploader">
        <div class="muted" style="font-size:12px;line-height:1.35">
          Guarde: passaporte, seguro, reservas, tickets, comprovantes.
          <br><b>Obs:</b> limite ~5‚Äì10MB. Imagens s√£o comprimidas automaticamente.
        </div>
        <div class="row" style="margin-top:10px">
          <input id="filePick" type="file" multiple accept="image/*,.pdf,.txt,.json,.csv,.doc,.docx,.xls,.xlsx" />
          <button class="btn small ghost" id="btnClearFiles">Limpar arquivos deste pa√≠s</button>
        </div>
      </div>
      <div class="files" id="files"></div>

      <div class="hr"></div>

      <h3>Lugares/Links (clic√°veis)</h3>
      <div class="muted" style="font-size:12px;margin-top:-6px;margin-bottom:8px">
        Padr√£o simples. Cole links do seu pa√≠s nas Notas & Links tamb√©m.
      </div>
      <div class="linkList" id="places"></div>

      <div class="hr"></div>

      <h3>Notas & Links</h3>
      <textarea id="notes" placeholder="Cole links aqui (reservas, seguro, mapas), ou escreva lembretes."></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="btnSaveNotes">Salvar notas</button>
        <button class="btn ghost" id="btnClearNotes">Limpar notas</button>
      </div>
    </aside>
  </div>
</div>

<script>
/* ======================
   v4 storage (countries)
====================== */
const K = {
  name: "partiu_name_v4",
  meta: "partiu_meta_v4",        // countries list + settings
  state: "partiu_state_v4",      // checklist per country id
  trip: "partiu_trip_v4",        // trip per country id
  notes: "partiu_notes_v4",      // notes per country id
  files: "partiu_files_v4",      // files per country id
  savedAt: "partiu_savedAt_v4",

  // old keys (v3) for migration
  old: {
    name: "partiu_name_v3",
    state: "partiu_state_v3",
    trip: "partiu_trip_v3",
    notes: "partiu_notes_v3",
    files: "partiu_files_v3",
    savedAt: "partiu_savedAt_v3"
  }
};

const CATS = [
  {key:"Documentos", color:"var(--doc)"},
  {key:"Sa√∫de", color:"var(--saude)"},
  {key:"Higiene", color:"var(--hig)"},
  {key:"Eletr√¥nicos", color:"var(--ele)"},
  {key:"Roupas", color:"var(--roup)"},
  {key:"Bagagem", color:"var(--bag)"},
  {key:"Financeiro", color:"var(--fin)"},
  {key:"Outros", color:"var(--out)"}
];

const BASE_ESSENTIALS = [
  ["Carregador do celular", "Eletr√¥nicos"],
  ["Cabo extra (reserva)", "Eletr√¥nicos"],
  ["Power bank carregado", "Eletr√¥nicos"],
  ["Rem√©dio pra dor de cabe√ßa", "Sa√∫de"],
  ["Rem√©dios de uso cont√≠nuo + receita", "Sa√∫de"],
  ["Band-aid/curativo", "Sa√∫de"],
  ["Escova de dente", "Higiene"],
  ["Pasta de dente", "Higiene"],
  ["Len√ßo umedecido", "Higiene"],
  ["√Ålcool em gel (pequeno)", "Higiene"],
  ["Desodorante", "Higiene"],
  ["Etiqueta de mala (nome/contato)", "Bagagem"],
  ["Mochila de m√£o organizada", "Bagagem"],
  ["Cart√µes + dinheiro em esp√©cie", "Financeiro"],
];

const CLIMATE_PACKS = {
  temperado: [
    ["Casaco corta-vento/chuva", "Roupas"],
    ["Camadas (segunda pele/moletom)", "Roupas"],
    ["T√™nis confort√°vel (muita caminhada)", "Roupas"],
    ["Adaptador de tomada (ver padr√£o do pa√≠s)", "Eletr√¥nicos"],
  ],
  tropical: [
    ["Protetor solar", "Sa√∫de"],
    ["Repelente", "Sa√∫de"],
    ["Capa de chuva leve", "Roupas"],
    ["Garrafa de √°gua", "Outros"],
  ],
  frio: [
    ["Casaco pesado", "Roupas"],
    ["Luvas + gorro", "Roupas"],
    ["Segunda pele t√©rmica", "Roupas"],
    ["Hidratante/lip balm", "Higiene"],
  ],
  deserto: [
    ["Protetor solar forte", "Sa√∫de"],
    ["√ìculos escuros", "Outros"],
    ["Hidratante/lip balm", "Higiene"],
    ["Garrafa de √°gua", "Outros"],
  ]
};

const DEFAULT_PLACES = {
  nl: [
    {t:"Anne Frank House (reservar)", u:"https://www.annefrank.org/"},
    {t:"Rijksmuseum", u:"https://www.rijksmuseum.nl/"},
    {t:"Van Gogh Museum", u:"https://www.vangoghmuseum.nl/"},
    {t:"I amsterdam", u:"https://www.iamsterdam.com/"},
    {t:"NS (trens)", u:"https://www.ns.nl/en"}
  ],
  br: [
    {t:"Google Maps", u:"https://maps.google.com/"},
    {t:"Windy (tempo)", u:"https://www.windy.com/"}
  ],
  generic: [
    {t:"Google Maps", u:"https://maps.google.com/"},
    {t:"Previs√£o do tempo (Windy)", u:"https://www.windy.com/"},
    {t:"Tradutor (Google Translate)", u:"https://translate.google.com/"}
  ]
};

/* ======================
   Helpers
====================== */
function nowISO(){ return new Date().toISOString(); }
function saveTS(){ localStorage.setItem(K.savedAt, nowISO()); renderSavedAt(); }
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
function uid(){ return crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(16).slice(2)+Date.now()); }

function loadJSON(key, fallback){
  const raw = localStorage.getItem(key);
  if(!raw) return fallback;
  try{ return JSON.parse(raw); }catch{ return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); saveTS(); }

function loadMeta(){
  const fb = {
    activeId: null,
    countries: [
      {id:"nl", name:"Holanda", climate:"temperado", fixed:true},
      {id:"br", name:"Brasil", climate:"tropical", fixed:true}
    ]
  };
  return loadJSON(K.meta, fb);
}
function saveMeta(meta){ saveJSON(K.meta, meta); }

function loadState(){ return loadJSON(K.state, {}); }
function loadTrip(){ return loadJSON(K.trip, {}); }
function loadNotes(){ return loadJSON(K.notes, {}); }
function loadFiles(){ return loadJSON(K.files, {}); }

function ensureCountryData(country){
  const st = loadState();
  if(!st[country.id]){
    const base = [...BASE_ESSENTIALS, ...(CLIMATE_PACKS[country.climate]||[])];
    // add doc essentials generic
    const docs = [
      ["Documento/passaporte (conforme destino)", "Documentos"],
      ["Passagens/itiner√°rio (print/PDF)", "Documentos"],
      ["Reserva/hospedagem (ou endere√ßo)", "Documentos"]
    ];
    st[country.id] = [...docs, ...base].map(([text,cat])=>({id:uid(), text, cat, done:false}));
    saveJSON(K.state, st);
  }
  const trip = loadTrip(); if(!trip[country.id]){ trip[country.id] = {}; saveJSON(K.trip, trip); }
  const notes = loadNotes(); if(typeof notes[country.id] !== "string"){ notes[country.id] = ""; saveJSON(K.notes, notes); }
  const files = loadFiles(); if(!Array.isArray(files[country.id])){ files[country.id] = []; saveJSON(K.files, files); }
}

/* ======================
   Migration from v3 -> v4
====================== */
(function migrateOnce(){
  const already = localStorage.getItem(K.meta);
  if(already) return;

  // Create meta
  const meta = loadMeta();

  // migrate name
  const oldName = localStorage.getItem(K.old.name);
  if(oldName && !localStorage.getItem(K.name)) localStorage.setItem(K.name, oldName);

  // migrate checklist (v3 had nl/br)
  const oldState = loadJSON(K.old.state, null);
  const st = {};
  if(oldState && (oldState.nl || oldState.br)){
    if(oldState.nl) st["nl"] = oldState.nl;
    if(oldState.br) st["br"] = oldState.br;
  }
  if(Object.keys(st).length) localStorage.setItem(K.state, JSON.stringify(st));

  // migrate trip/notes/files
  const oldTrip = loadJSON(K.old.trip, null);
  if(oldTrip && (oldTrip.nl || oldTrip.br)) localStorage.setItem(K.trip, JSON.stringify({nl: oldTrip.nl||{}, br: oldTrip.br||{}}));

  const oldNotes = loadJSON(K.old.notes, null);
  if(oldNotes && (oldNotes.nl || oldNotes.br)) localStorage.setItem(K.notes, JSON.stringify({nl: oldNotes.nl||"", br: oldNotes.br||""}));

  const oldFiles = loadJSON(K.old.files, null);
  if(oldFiles && (oldFiles.nl || oldFiles.br)) localStorage.setItem(K.files, JSON.stringify({nl: oldFiles.nl||[], br: oldFiles.br||[]}));

  // savedAt
  const oldSavedAt = localStorage.getItem(K.old.savedAt);
  if(oldSavedAt) localStorage.setItem(K.savedAt, oldSavedAt);

  // activate NL by default
  meta.activeId = "nl";
  localStorage.setItem(K.meta, JSON.stringify(meta));
})();

/* ======================
   UI refs
====================== */
const nameEl = document.getElementById("name");
const bigNameEl = document.getElementById("bigName");
const tabsEl = document.getElementById("tabs");
const tabLabelEl = document.getElementById("tabLabel");

const catsEl = document.getElementById("cats");
const fillEl = document.getElementById("fill");
const pctEl = document.getElementById("pct");
const itemsCountEl = document.getElementById("itemsCount");

const tripDateEl = document.getElementById("tripDate");
const fromEl = document.getElementById("from");
const toEl = document.getElementById("to");
const flightEl = document.getElementById("flight");
const gateEl = document.getElementById("gate");
const connectCityEl = document.getElementById("connectCity");
const connectGateEl = document.getElementById("connectGate");
const baggageEl = document.getElementById("baggage");
const tripNotesEl = document.getElementById("tripNotes");

const countdownBox = document.getElementById("countdownBox");
const countdownTitle = document.getElementById("countdownTitle");
const countdownText = document.getElementById("countdownText");

const notesEl = document.getElementById("notes");
const placesEl = document.getElementById("places");

const filePick = document.getElementById("filePick");
const filesEl = document.getElementById("files");

/* ======================
   Active country getters
====================== */
function getMeta(){ return loadMeta(); }
function getActiveCountry(){
  const meta = getMeta();
  const id = meta.activeId || meta.countries[0].id;
  return meta.countries.find(c=>c.id===id) || meta.countries[0];
}
function setActiveCountry(id){
  const meta = getMeta();
  meta.activeId = id;
  saveMeta(meta);
  renderAll();
}

/* ======================
   Name
====================== */
nameEl.value = localStorage.getItem(K.name) || "";
function applyName(){
  const n = nameEl.value.trim();
  localStorage.setItem(K.name, n);
  bigNameEl.textContent = n ? `${n} ‚Äî seu checklist` : "Seu checklist";
}
nameEl.addEventListener("input", applyName);
applyName();

/* ======================
   Tabs render + delete
====================== */
function renderTabs(){
  const meta = getMeta();
  // remove old injected tabs (keep add button)
  const addBtn = document.getElementById("btnAddCountry");
  tabsEl.innerHTML = "";
  meta.countries.forEach(c=>{
    const t = document.createElement("div");
    t.className = "tab" + ((meta.activeId||"nl")===c.id ? " active" : "");
    t.innerHTML = `${esc(c.name)} <span class="muted" style="font-size:12px">(${esc(c.climate)})</span>` + (c.fixed ? "" : `<span class="x" title="Remover pa√≠s">√ó</span>`);
    t.addEventListener("click", (ev)=>{
      // if clicked X
      if(!c.fixed && ev.target && ev.target.classList.contains("x")){
        ev.stopPropagation();
        removeCountry(c.id);
        return;
      }
      setActiveCountry(c.id);
    });
    tabsEl.appendChild(t);
  });
  tabsEl.appendChild(addBtn);
}

/* ======================
   Add/remove country modal
====================== */
const modalBack = document.getElementById("modalBack");
const newCountryName = document.getElementById("newCountryName");
const newCountryClimate = document.getElementById("newCountryClimate");

document.getElementById("btnAddCountry").addEventListener("click", ()=>{
  newCountryName.value = "";
  newCountryClimate.value = "temperado";
  modalBack.style.display = "flex";
  setTimeout(()=>newCountryName.focus(), 20);
});
document.getElementById("btnCancelCountry").addEventListener("click", ()=> modalBack.style.display="none");
modalBack.addEventListener("click", (e)=>{ if(e.target===modalBack) modalBack.style.display="none"; });

document.getElementById("btnCreateCountry").addEventListener("click", ()=>{
  const name = (newCountryName.value||"").trim();
  const climate = newCountryClimate.value;
  if(!name){ alert("Digite o nome do pa√≠s."); return; }

  const meta = getMeta();
  // create id safe
  let id = name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"");
  if(!id) id = uid();
  // avoid collisions
  if(meta.countries.some(c=>c.id===id)) id = id + "-" + Math.floor(Math.random()*999);

  const country = {id, name, climate, fixed:false};
  meta.countries.push(country);
  meta.activeId = id;
  saveMeta(meta);

  ensureCountryData(country);
  modalBack.style.display="none";
  renderAll();
});

function removeCountry(id){
  if(!confirm("Remover este pa√≠s? (dados locais deste pa√≠s ser√£o apagados)")) return;

  const meta = getMeta();
  const idx = meta.countries.findIndex(c=>c.id===id);
  if(idx<0) return;
  const wasActive = meta.activeId===id;

  meta.countries = meta.countries.filter(c=>c.id!==id);
  if(wasActive) meta.activeId = meta.countries[0]?.id || "nl";
  saveMeta(meta);

  // delete data
  const st = loadState(); delete st[id]; saveJSON(K.state, st);
  const tr = loadTrip(); delete tr[id]; saveJSON(K.trip, tr);
  const nt = loadNotes(); delete nt[id]; saveJSON(K.notes, nt);
  const fl = loadFiles(); delete fl[id]; saveJSON(K.files, fl);

  renderAll();
}

/* ======================
   Checklist render
====================== */
function renderChecklist(){
  const country = getActiveCountry();
  ensureCountryData(country);

  const st = loadState();
  const list = st[country.id] || [];

  const total = list.length || 1;
  const done = list.filter(x=>x.done).length;
  const pct = Math.round((done/total)*100);
  fillEl.style.width = pct + "%";
  pctEl.textContent = `${pct}% (${done}/${list.length})`;
  itemsCountEl.textContent = `${list.length} itens`;

  if(list.length>0 && done===list.length) confetti();

  const map = {};
  CATS.forEach(c=>map[c.key]=[]);
  list.forEach(it=>{
    if(!map[it.cat]) map[it.cat]=[];
    map[it.cat].push(it);
  });

  catsEl.innerHTML = "";
  CATS.forEach(cat=>{
    const arr = map[cat.key] || [];
    const d = arr.filter(x=>x.done).length;

    const card = document.createElement("div");
    card.className = "catCard";

    const head = document.createElement("div");
    head.className = "catHead";
    head.style.background = `linear-gradient(135deg, ${cat.color}, rgba(17,24,39,.85))`;
    head.innerHTML = `<b>${esc(cat.key)}</b><div class="count">${d}/${arr.length}</div>`;

    const body = document.createElement("div");
    body.className = "catBody";

    const listBox = document.createElement("div");
    listBox.className = "list";

    arr.forEach(item=>{
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <input type="checkbox" ${item.done?"checked":""}/>
        <div class="meta"><b>${esc(item.text)}</b></div>
        <div class="actions">
          <button class="btn small ghost" title="Editar">‚úèÔ∏è</button>
          <button class="btn small danger" title="Excluir">üóëÔ∏è</button>
        </div>
      `;

      const cb = row.querySelector('input[type="checkbox"]');
      const btnE = row.querySelectorAll("button")[0];
      const btnD = row.querySelectorAll("button")[1];

      cb.addEventListener("change", ()=>{
        const s = loadState();
        const a = s[country.id] || [];
        const idx = a.findIndex(x=>x.id===item.id);
        if(idx>=0){ a[idx].done = cb.checked; s[country.id]=a; saveJSON(K.state, s); }
        renderAll();
      });

      btnE.addEventListener("click", ()=>{
        const nt = prompt("Editar item:", item.text);
        if(nt===null) return;
        const s = loadState();
        const a = s[country.id] || [];
        const idx = a.findIndex(x=>x.id===item.id);
        if(idx>=0){ a[idx].text = (nt.trim()||a[idx].text); s[country.id]=a; saveJSON(K.state, s); }
        renderAll();
      });

      btnD.addEventListener("click", ()=>{
        if(!confirm("Excluir este item?")) return;
        const s = loadState();
        const a = (s[country.id] || []).filter(x=>x.id!==item.id);
        s[country.id]=a;
        saveJSON(K.state, s);
        renderAll();
      });

      listBox.appendChild(row);
    });

    const add = document.createElement("div");
    add.className = "addMini";
    add.innerHTML = `
      <input type="text" placeholder="Adicionar em ${esc(cat.key)}" />
      <button class="btn small">Adicionar</button>
    `;
    const inp = add.querySelector("input");
    const btn = add.querySelector("button");
    btn.addEventListener("click", ()=>{
      const txt = inp.value.trim();
      if(!txt) return;
      const s = loadState();
      const a = s[country.id] || [];
      a.push({id:uid(), text:txt, cat:cat.key, done:false});
      s[country.id]=a;
      saveJSON(K.state, s);
      inp.value="";
      renderAll();
    });

    body.appendChild(listBox);
    body.appendChild(add);

    card.appendChild(head);
    card.appendChild(body);
    catsEl.appendChild(card);
  });
}

/* ======================
   Trip + countdown
====================== */
function renderTrip(){
  const country = getActiveCountry();
  ensureCountryData(country);

  tabLabelEl.textContent = `${country.name} (${country.climate})`;

  const trips = loadTrip();
  const t = trips[country.id] || {};

  tripDateEl.value = t.tripDate || "";
  fromEl.value = t.from || "";
  toEl.value = t.to || "";
  flightEl.value = t.flight || "";
  gateEl.value = t.gate || "";
  connectCityEl.value = t.connectCity || "";
  connectGateEl.value = t.connectGate || "";
  baggageEl.value = t.baggage || "";
  tripNotesEl.value = t.tripNotes || "";

  renderCountdown();
}

function saveTripFromForm(){
  const country = getActiveCountry();
  const trips = loadTrip();
  trips[country.id] = {
    tripDate: tripDateEl.value || "",
    from: fromEl.value.trim(),
    to: toEl.value.trim(),
    flight: flightEl.value.trim(),
    gate: gateEl.value.trim(),
    connectCity: connectCityEl.value.trim(),
    connectGate: connectGateEl.value.trim(),
    baggage: baggageEl.value.trim(),
    tripNotes: tripNotesEl.value.trim()
  };
  saveJSON(K.trip, trips);
  renderCountdown();
}

document.getElementById("btnSaveTrip").addEventListener("click", ()=>{
  saveTripFromForm();
  alert("Cart√£o da viagem salvo ‚úÖ");
});
document.getElementById("btnClearTrip").addEventListener("click", ()=>{
  if(!confirm("Limpar cart√£o da viagem deste pa√≠s?")) return;
  const country = getActiveCountry();
  const trips = loadTrip();
  trips[country.id] = {};
  saveJSON(K.trip, trips);
  renderTrip();
});

function renderCountdown(){
  const country = getActiveCountry();
  const trips = loadTrip();
  const t = trips[country.id] || {};
  const val = t.tripDate || "";

  countdownBox.classList.remove("ok","bad");

  if(!val){
    countdownTitle.textContent = "Defina a data/hora da viagem";
    countdownText.textContent = "Preencha o Cart√£o da Viagem para ver a contagem regressiva e alerta.";
    countdownBox.querySelector(".dot").style.background = "var(--warn)";
    return;
  }

  const target = new Date(val);
  const now = new Date();
  const diffMs = target - now;

  if(isNaN(target.getTime())){
    countdownTitle.textContent = "Data inv√°lida";
    countdownText.textContent = "Ajuste a data/hora no cart√£o.";
    countdownBox.classList.add("bad");
    return;
  }

  if(diffMs < 0){
    countdownTitle.textContent = "Boa viagem! (data j√° passou)";
    countdownText.textContent = "Atualize para o pr√≥ximo trecho ou pr√≥xima viagem.";
    countdownBox.classList.add("ok");
    countdownBox.querySelector(".dot").style.background = "var(--ok)";
    return;
  }

  const mins = Math.floor(diffMs/60000);
  const days = Math.floor(mins/(60*24));
  const hrs = Math.floor((mins - days*24*60)/60);
  const m = mins - days*24*60 - hrs*60;

  const totalHours = diffMs / 3600000;

  if(totalHours <= 12){
    countdownTitle.textContent = "ALERTA: sua viagem est√° muito perto!";
    countdownText.textContent = `Faltam ${hrs}h ${m}min. Confere documentos, carregadores e chegue cedo.`;
    countdownBox.classList.add("bad");
    countdownBox.querySelector(".dot").style.background = "var(--bad)";
  }else if(totalHours <= 36){
    countdownTitle.textContent = "Amanh√£ / nas pr√≥ximas 24‚Äì36h";
    countdownText.textContent = `Faltam ${days}d ${hrs}h. Hoje √© dia de revisar tudo e separar a mochila.`;
    countdownBox.querySelector(".dot").style.background = "var(--warn)";
  }else{
    countdownTitle.textContent = "Contagem regressiva";
    countdownText.textContent = `Faltam ${days}d ${hrs}h ${m}min para a sa√≠da.`;
    countdownBox.classList.add("ok");
    countdownBox.querySelector(".dot").style.background = "var(--ok)";
  }
}

/* ======================
   Notes + places
====================== */
function renderNotes(){
  const country = getActiveCountry();
  const n = loadNotes();
  notesEl.value = n[country.id] || "";
}

document.getElementById("btnSaveNotes").addEventListener("click", ()=>{
  const country = getActiveCountry();
  const n = loadNotes();
  n[country.id] = notesEl.value;
  saveJSON(K.notes, n);
  alert("Notas salvas ‚úÖ");
});
document.getElementById("btnClearNotes").addEventListener("click", ()=>{
  if(!confirm("Limpar notas deste pa√≠s?")) return;
  const country = getActiveCountry();
  const n = loadNotes();
  n[country.id] = "";
  saveJSON(K.notes, n);
  renderNotes();
});

function renderPlaces(){
  const meta = getMeta();
  const country = getActiveCountry();

  // special defaults for NL/BR
  let places = DEFAULT_PLACES.generic;
  if(country.id==="nl") places = DEFAULT_PLACES.nl;
  if(country.id==="br") places = DEFAULT_PLACES.br;

  // add one climate hint link line (text only)
  let hint = "";
  if(country.climate==="tropical") hint = "‚Ä¢ Dica: calor/chuva ‚Üí repelente, protetor, capa de chuva.";
  if(country.climate==="temperado") hint = "‚Ä¢ Dica: vento/frio ‚Üí camadas + corta-vento/chuva.";
  if(country.climate==="frio") hint = "‚Ä¢ Dica: frio forte ‚Üí luvas/gorro + t√©rmica.";
  if(country.climate==="deserto") hint = "‚Ä¢ Dica: seco/sol ‚Üí protetor + hidrata√ß√£o.";

  placesEl.innerHTML =
    (hint ? (esc(hint).replaceAll("&amp;#8226;","‚Ä¢") + "<br/>") : "") +
    places.map(x=>`‚Ä¢ <a target="_blank" rel="noopener" href="${esc(x.u)}">${esc(x.t)}</a>`).join("<br/>");
}

/* ======================
   Files
====================== */
filePick.addEventListener("change", async (e)=>{
  const country = getActiveCountry();
  const selected = Array.from(e.target.files || []);
  if(!selected.length) return;

  for(const f of selected){
    if(f.size > 3_000_000){
      alert(`Arquivo grande demais: ${f.name}\nTenta reduzir (imagem menor / PDF mais leve).`);
      continue;
    }
    const entry = await fileToEntry(f);
    if(!entry) continue;

    const all = loadFiles();
    all[country.id] = all[country.id] || [];
    all[country.id].unshift(entry);

    try{
      saveJSON(K.files, all);
    }catch(err){
      alert("LocalStorage lotou. Apague alguns arquivos/fotos ou exporte backup e limpe.");
      break;
    }
  }

  filePick.value = "";
  renderFiles();
});

document.getElementById("btnClearFiles").addEventListener("click", ()=>{
  if(!confirm("Remover TODOS os arquivos deste pa√≠s?")) return;
  const country = getActiveCountry();
  const all = loadFiles();
  all[country.id] = [];
  saveJSON(K.files, all);
  renderFiles();
});

function renderFiles(){
  const country = getActiveCountry();
  const all = loadFiles();
  const arr = all[country.id] || [];
  filesEl.innerHTML = "";

  if(!arr.length){
    filesEl.innerHTML = `<div class="muted" style="font-size:12px;">Nenhum arquivo neste pa√≠s ainda.</div>`;
    return;
  }

  arr.forEach(entry=>{
    const row = document.createElement("div");
    row.className = "fileRow";

    const left = document.createElement("div");
    left.className = "fileLeft";

    const thumb = document.createElement("div");
    thumb.className = "thumb";

    if(entry.kind === "image"){
      const img = document.createElement("img");
      img.src = entry.dataUrl;
      thumb.appendChild(img);
    }else{
      thumb.textContent = "üìé";
    }

    const meta = document.createElement("div");
    meta.className = "fname";
    const kb = Math.round((entry.size||0)/1024);
    meta.innerHTML = `<b>${esc(entry.name)}</b><small>${esc(entry.type)} ‚Ä¢ ${kb} KB</small>`;

    left.appendChild(thumb);
    left.appendChild(meta);

    const right = document.createElement("div");
    right.className = "row";

    const open = document.createElement("a");
    open.className = "link";
    open.href = entry.dataUrl;
    open.target = "_blank";
    open.rel = "noopener";
    open.textContent = "Abrir";

    const del = document.createElement("button");
    del.className = "btn small danger";
    del.textContent = "Excluir";
    del.addEventListener("click", ()=>{
      if(!confirm("Excluir este arquivo?")) return;
      const all2 = loadFiles();
      all2[country.id] = (all2[country.id]||[]).filter(x=>x.id !== entry.id);
      saveJSON(K.files, all2);
      renderFiles();
    });

    right.appendChild(open);
    right.appendChild(del);

    row.appendChild(left);
    row.appendChild(right);
    filesEl.appendChild(row);
  });
}

async function fileToEntry(file){
  const isImage = (file.type || "").startsWith("image/");
  const dataUrl = await readAsDataURL(file);

  if(isImage){
    const compressed = await compressImageDataUrl(dataUrl, 1280, 0.82);
    return { id: uid(), name: file.name, type: file.type||"image/jpeg", size: file.size, kind:"image", dataUrl: compressed, addedAt: nowISO() };
  }else{
    return { id: uid(), name: file.name, type: file.type||"application/octet-stream", size: file.size, kind:"file", dataUrl, addedAt: nowISO() };
  }
}
function readAsDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}
function compressImageDataUrl(dataUrl, maxW, quality){
  return new Promise((res)=>{
    const img = new Image();
    img.onload = ()=>{
      const scale = Math.min(1, maxW / img.width);
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      const ctx = c.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);
      res(c.toDataURL("image/jpeg", quality));
    };
    img.onerror = ()=>res(dataUrl);
    img.src = dataUrl;
  });
}

/* ======================
   Buttons: defaults/reset
====================== */
document.getElementById("btnDefault").addEventListener("click", ()=>{
  const country = getActiveCountry();
  if(!confirm("Recarregar itens padr√£o deste pa√≠s? Isso substitui sua lista atual.")) return;

  const st = loadState();
  const base = [...BASE_ESSENTIALS, ...(CLIMATE_PACKS[country.climate]||[])];
  const docs = [
    ["Documento/passaporte (conforme destino)", "Documentos"],
    ["Passagens/itiner√°rio (print/PDF)", "Documentos"],
    ["Reserva/hospedagem (ou endere√ßo)", "Documentos"]
  ];
  st[country.id] = [...docs, ...base].map(([text,cat])=>({id:uid(), text, cat, done:false}));
  saveJSON(K.state, st);
  renderAll();
});
document.getElementById("btnUncheck").addEventListener("click", ()=>{
  const country = getActiveCountry();
  const st = loadState();
  st[country.id] = (st[country.id]||[]).map(x=>({...x, done:false}));
  saveJSON(K.state, st);
  renderAll();
});
document.getElementById("btnResetTab").addEventListener("click", ()=>{
  const country = getActiveCountry();
  if(!confirm("Resetar TUDO deste pa√≠s (checklist + cart√£o + notas + arquivos)?")) return;

  const st = loadState(); st[country.id] = null; delete st[country.id]; saveJSON(K.state, st);
  const tr = loadTrip(); tr[country.id] = {}; saveJSON(K.trip, tr);
  const nt = loadNotes(); nt[country.id] = ""; saveJSON(K.notes, nt);
  const fl = loadFiles(); fl[country.id] = []; saveJSON(K.files, fl);

  ensureCountryData(country);
  renderAll();
});

/* ======================
   Export/import backup
====================== */
document.getElementById("btnExport").addEventListener("click", ()=>{
  const data = {
    version: 4,
    exportedAt: nowISO(),
    name: localStorage.getItem(K.name) || "",
    meta: getMeta(),
    state: loadState(),
    trip: loadTrip(),
    notes: loadNotes(),
    files: loadFiles()
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `partiu-backup-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

document.getElementById("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!confirm("Importar vai sobrescrever seus dados atuais. Continuar?")) return;

    if(typeof data.name==="string"){ localStorage.setItem(K.name, data.name); nameEl.value=data.name; applyName(); }
    if(data.meta) localStorage.setItem(K.meta, JSON.stringify(data.meta));
    if(data.state) localStorage.setItem(K.state, JSON.stringify(data.state));
    if(data.trip) localStorage.setItem(K.trip, JSON.stringify(data.trip));
    if(data.notes) localStorage.setItem(K.notes, JSON.stringify(data.notes));
    if(data.files) localStorage.setItem(K.files, JSON.stringify(data.files));

    saveTS();
    alert("Backup importado ‚úÖ");
    renderAll();
  }catch(err){
    alert("Falha ao importar. Verifique se √© um backup do app (JSON).");
  }finally{
    e.target.value="";
  }
});

/* ======================
   Last saved
====================== */
function renderSavedAt(){
  const el = document.getElementById("lastSaved");
  const raw = localStorage.getItem(K.savedAt);
  if(!raw){ el.textContent = "n√£o salvo ainda"; return; }
  el.textContent = "salvo: " + new Date(raw).toLocaleString();
}

/* ======================
   Confetti
====================== */
const fx = document.getElementById("fx");
const ctxFx = fx.getContext("2d");
let confettiOn = false;

function confetti(){
  if(confettiOn) return;
  confettiOn = true;
  fx.style.display = "block";
  resizeFx();

  const pieces = Array.from({length: 120}).map(()=>({
    x: Math.random()*fx.width,
    y: -20 - Math.random()*fx.height*0.3,
    r: 4 + Math.random()*6,
    vy: 2 + Math.random()*4,
    vx: -1 + Math.random()*2,
    a: Math.random()*Math.PI
  }));

  let t = 0;
  const timer = setInterval(()=>{
    t++;
    ctxFx.clearRect(0,0,fx.width,fx.height);
    pieces.forEach(p=>{
      p.y += p.vy; p.x += p.vx; p.a += 0.08;
      ctxFx.save();
      ctxFx.translate(p.x,p.y);
      ctxFx.rotate(p.a);
      ctxFx.fillStyle = `hsla(${Math.random()*360}, 90%, 55%, .9)`;
      ctxFx.fillRect(-p.r/2, -p.r/2, p.r, p.r*1.6);
      ctxFx.restore();
    });

    if(t>70){
      clearInterval(timer);
      ctxFx.clearRect(0,0,fx.width,fx.height);
      fx.style.display = "none";
      confettiOn = false;
    }
  }, 16);
}
function resizeFx(){ fx.width = window.innerWidth; fx.height = window.innerHeight; }
window.addEventListener("resize", resizeFx);

/* ======================
   Render all
====================== */
function renderTripCountdownAndNotes(){
  renderTrip();
  renderNotes();
  renderPlaces();
  renderFiles();
}

function renderNotes(){
  const country = getActiveCountry();
  const n = loadNotes();
  notesEl.value = n[country.id] || "";
}

function renderAll(){
  renderTabs();
  const country = getActiveCountry();
  ensureCountryData(country);
  renderSavedAt();
  renderChecklist();
  renderTripCountdownAndNotes();
}
renderAll();
setInterval(()=>renderCountdown(), 30000);

/* Trip save handlers */
document.getElementById("btnSaveTrip").addEventListener("click", ()=>{
  saveTripFromForm();
  alert("Cart√£o da viagem salvo ‚úÖ");
});

/* Notes handled earlier */
</script>
</body>
</html>
